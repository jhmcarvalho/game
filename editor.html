<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Editor de Mapa</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #111; color: #eee; font-family: Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

  #toolbar {
    background: #1e1e1e;
    border-bottom: 2px solid #333;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
    flex-wrap: wrap;
  }

  #toolbar h1 { font-size: 14px; color: #00aaff; white-space: nowrap; }
  .sep { width: 1px; height: 28px; background: #444; margin: 0 2px; }

  button {
    padding: 6px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
    transition: opacity .15s;
    white-space: nowrap;
  }
  button:hover { opacity: .85; }

  .tool-btn { background: #333; color: #aaa; border: 2px solid transparent; }
  .tool-btn.active { border-color: #00aaff; color: #fff; background: #1a2a4a; }

  .tool-btn.desk-btn { background: #332200; color: #ffcc00; }
  .tool-btn.desk-btn.active { border-color: #ffcc00; background: #3a2a00; color: #ffe066; }

  .zoom-btn { background: #444; color: #fff; min-width: 30px; padding: 6px 10px; }

  #save-coll-btn { background: #cc3300; color: #fff; }
  #save-zones-btn { background: #cc8800; color: #fff; }
  #clear-coll-btn { background: #550000; color: #fff; }
  #clear-zones-btn { background: #554400; color: #fff; }

  #zoom-label { font-size: 12px; color: #aaa; min-width: 36px; text-align: center; }
  #status { font-size: 12px; padding: 4px 10px; border-radius: 4px; background: #222; min-width: 180px; }
  #tile-info { font-size: 11px; color: #888; min-width: 110px; }

  .legend { display: flex; align-items: center; gap: 5px; font-size: 11px; color: #aaa; }
  .legend-box { width: 12px; height: 12px; border-radius: 2px; }

  #layer-label { font-size: 12px; color: #888; }

  #viewport { flex: 1; overflow: auto; cursor: crosshair; background: #000; }
  #editor-canvas { display: block; image-rendering: pixelated; image-rendering: crisp-edges; }
</style>
</head>
<body>

<div id="toolbar">
  <h1>ğŸ—ºï¸ Editor de Mapa</h1>
  <div class="sep"></div>

  <!-- Layer tabs -->
  <span id="layer-label">Camada:</span>
  <button class="tool-btn active" id="layer-coll-btn" title="Editar colisÃµes">ğŸ§± ColisÃµes</button>
  <button class="tool-btn desk-btn" id="layer-zone-btn" title="Marcar Ã¡reas de mesa">ğŸª‘ Mesas</button>

  <div class="sep"></div>

  <!-- Paint mode -->
  <button class="tool-btn active" id="tool-add">âœï¸ Pintar</button>
  <button class="tool-btn" id="tool-remove">ğŸ§¹ Apagar</button>

  <div class="sep"></div>

  <!-- Zoom -->
  <button class="zoom-btn" id="zoom-out">âˆ’</button>
  <span id="zoom-label">2Ã—</span>
  <button class="zoom-btn" id="zoom-in">+</button>

  <div class="sep"></div>
  <button class="tool-btn" id="toggle-grid">ğŸ“ Grid</button>

  <div class="sep"></div>

  <button id="save-coll-btn">ğŸ’¾ Salvar ColisÃµes</button>
  <button id="save-zones-btn">ğŸ’¾ Salvar Mesas</button>

  <div class="sep"></div>

  <button id="clear-coll-btn" title="Remove todas as colisÃµes">ğŸ—‘ï¸ Limpar Col.</button>
  <button id="clear-zones-btn" title="Remove todas as marcaÃ§Ãµes de mesa">ğŸ—‘ï¸ Limpar Mesas</button>

  <div class="sep"></div>

  <span id="status">Carregando...</span>
  <span id="tile-info">Tile: â€”</span>

  <div class="sep"></div>
  <div class="legend">
    <div class="legend-box" style="background:rgba(255,50,50,.6);border:1px solid red"></div> ColisÃ£o
    <div class="legend-box" style="background:rgba(255,190,0,.55);border:1px solid orange; margin-left:8px"></div> Mesa
  </div>
  <span style="font-size:11px;color:#555">| BotÃ£o direito: apagar | Scroll: zoom</span>
</div>

<div id="viewport">
  <canvas id="editor-canvas"></canvas>
</div>

<script>
const TILE   = 12;
const COLS   = 202;
const ROWS   = 144;

let scale    = 2;
let showGrid = true;
let mode     = 'add';    // 'add' | 'remove'
let layer    = 'collision'; // 'collision' | 'zone'

let collisions = new Array(COLS * ROWS).fill(0);
let zones      = new Array(COLS * ROWS).fill(0);
let isPainting = false;
let lastTile   = { col: -1, row: -1 };

const canvas   = document.getElementById('editor-canvas');
const ctx      = canvas.getContext('2d');
const viewport = document.getElementById('viewport');
const mapImg   = new Image();
let mapLoaded  = false;

// â”€â”€â”€ Drawing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resizeCanvas() {
  canvas.width  = COLS * TILE * scale;
  canvas.height = ROWS * TILE * scale;
}

function redrawAll() {
  resizeCanvas();
  ctx.imageSmoothingEnabled = false;

  if (mapLoaded) {
    ctx.drawImage(mapImg, 0, 0, canvas.width, canvas.height);
  } else {
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  const ts = TILE * scale;

  // Zone overlay (amber)
  ctx.fillStyle = 'rgba(255, 190, 0, 0.45)';
  for (let row = 0; row < ROWS; row++)
    for (let col = 0; col < COLS; col++)
      if (zones[row * COLS + col] === 1)
        ctx.fillRect(col * ts, row * ts, ts, ts);

  // Collision overlay (red)
  ctx.fillStyle = 'rgba(255, 50, 50, 0.50)';
  for (let row = 0; row < ROWS; row++)
    for (let col = 0; col < COLS; col++)
      if (collisions[row * COLS + col] === 1025)
        ctx.fillRect(col * ts, row * ts, ts, ts);

  if (showGrid) drawGrid();
}

function drawGrid() {
  const ts = TILE * scale;
  ctx.strokeStyle = 'rgba(255,255,255,0.10)';
  ctx.lineWidth = 0.5;
  for (let c = 0; c <= COLS; c++) {
    ctx.beginPath(); ctx.moveTo(c * ts, 0); ctx.lineTo(c * ts, canvas.height); ctx.stroke();
  }
  for (let r = 0; r <= ROWS; r++) {
    ctx.beginPath(); ctx.moveTo(0, r * ts); ctx.lineTo(canvas.width, r * ts); ctx.stroke();
  }
}

function repaintTile(col, row) {
  const ts = TILE * scale;
  const px = col * ts, py = row * ts;

  ctx.imageSmoothingEnabled = false;
  if (mapLoaded) {
    ctx.drawImage(mapImg, col * TILE, row * TILE, TILE, TILE, px, py, ts, ts);
  } else {
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(px, py, ts, ts);
  }

  // Zone first, then collision on top
  if (zones[row * COLS + col] === 1) {
    ctx.fillStyle = 'rgba(255, 190, 0, 0.45)';
    ctx.fillRect(px, py, ts, ts);
  }
  if (collisions[row * COLS + col] === 1025) {
    ctx.fillStyle = 'rgba(255, 50, 50, 0.50)';
    ctx.fillRect(px, py, ts, ts);
  }

  if (showGrid) {
    ctx.strokeStyle = 'rgba(255,255,255,0.10)';
    ctx.lineWidth = 0.5;
    ctx.strokeRect(px, py, ts, ts);
  }
}

// â”€â”€â”€ Painting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function paintTile(col, row, painting) {
  if (col < 0 || col >= COLS || row < 0 || row >= ROWS) return;
  const idx = row * COLS + col;

  if (layer === 'collision') {
    const val = painting === 'add' ? 1025 : 0;
    if (collisions[idx] === val) return;
    collisions[idx] = val;
  } else {
    const val = painting === 'add' ? 1 : 0;
    if (zones[idx] === val) return;
    zones[idx] = val;
  }
  repaintTile(col, row);
}

function getTileFromEvent(e) {
  const rect = canvas.getBoundingClientRect();
  const sx = (e.clientX - rect.left)  * (canvas.width  / rect.width);
  const sy = (e.clientY - rect.top)   * (canvas.height / rect.height);
  return { col: Math.floor(sx / (TILE * scale)), row: Math.floor(sy / (TILE * scale)) };
}

canvas.addEventListener('mousedown', (e) => {
  e.preventDefault();
  isPainting = true;
  const painting = e.button === 2 ? 'remove' : mode;
  const { col, row } = getTileFromEvent(e);
  lastTile = { col, row };
  paintTile(col, row, painting);
  document.getElementById('tile-info').textContent = `Tile: (${col}, ${row})`;
});

canvas.addEventListener('mousemove', (e) => {
  const { col, row } = getTileFromEvent(e);
  document.getElementById('tile-info').textContent = `Tile: (${col}, ${row})`;
  if (!isPainting) return;
  if (col === lastTile.col && row === lastTile.row) return;
  lastTile = { col, row };
  const painting = (e.buttons & 2) ? 'remove' : mode;
  paintTile(col, row, painting);
});

canvas.addEventListener('mouseup',    () => { isPainting = false; });
canvas.addEventListener('mouseleave', () => { isPainting = false; });
canvas.addEventListener('contextmenu', (e) => e.preventDefault());

// â”€â”€â”€ Zoom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setZoom(ns) {
  const vp = viewport;
  const cx = vp.scrollLeft + vp.clientWidth  / 2;
  const cy = vp.scrollTop  + vp.clientHeight / 2;
  const ratio = ns / scale;
  scale = ns;
  document.getElementById('zoom-label').textContent = scale + 'Ã—';
  redrawAll();
  vp.scrollLeft = cx * ratio - vp.clientWidth  / 2;
  vp.scrollTop  = cy * ratio - vp.clientHeight / 2;
}

document.getElementById('zoom-in').onclick  = () => { if (scale < 6) setZoom(scale + 1); };
document.getElementById('zoom-out').onclick = () => { if (scale > 1) setZoom(scale - 1); };
viewport.addEventListener('wheel', (e) => {
  e.preventDefault();
  const ns = Math.max(1, Math.min(6, scale + (e.deltaY < 0 ? 1 : -1)));
  if (ns !== scale) setZoom(ns);
}, { passive: false });

// â”€â”€â”€ Tool / Layer toggles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('tool-add').onclick = () => {
  mode = 'add';
  document.getElementById('tool-add').classList.add('active');
  document.getElementById('tool-remove').classList.remove('active');
};
document.getElementById('tool-remove').onclick = () => {
  mode = 'remove';
  document.getElementById('tool-remove').classList.add('active');
  document.getElementById('tool-add').classList.remove('active');
};

document.getElementById('layer-coll-btn').onclick = () => {
  layer = 'collision';
  document.getElementById('layer-coll-btn').classList.add('active');
  document.getElementById('layer-zone-btn').classList.remove('active');
  document.getElementById('tool-add').textContent = 'âœï¸ Pintar';
};
document.getElementById('layer-zone-btn').onclick = () => {
  layer = 'zone';
  document.getElementById('layer-zone-btn').classList.add('active');
  document.getElementById('layer-coll-btn').classList.remove('active');
  document.getElementById('tool-add').textContent = 'ğŸª‘ Marcar Mesa';
};

// Grid toggle
const gridBtn = document.getElementById('toggle-grid');
gridBtn.classList.add('active');
gridBtn.onclick = () => {
  showGrid = !showGrid;
  gridBtn.classList.toggle('active', showGrid);
  redrawAll();
};

// â”€â”€â”€ Clear â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('clear-coll-btn').onclick = () => {
  if (!confirm('Remover TODAS as colisÃµes?')) return;
  collisions.fill(0);
  redrawAll();
};
document.getElementById('clear-zones-btn').onclick = () => {
  if (!confirm('Remover TODAS as marcaÃ§Ãµes de mesa?')) return;
  zones.fill(0);
  redrawAll();
};

// â”€â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveData(url, body, msg) {
  const status = document.getElementById('status');
  status.textContent = 'â³ Salvando...';
  status.style.color = '#ffcc00';
  try {
    const res  = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    const data = await res.json();
    status.textContent = data.ok ? `âœ… ${msg} Recarregue o jogo.` : 'âŒ Erro ao salvar.';
    status.style.color  = data.ok ? '#00cc66' : '#ff4444';
  } catch {
    status.textContent = 'âŒ Erro de conexÃ£o.';
    status.style.color  = '#ff4444';
  }
}

document.getElementById('save-coll-btn').onclick  = () => saveData('/api/save-collisions', { collisions }, 'ColisÃµes salvas!');
document.getElementById('save-zones-btn').onclick = () => saveData('/api/save-zones',      { zones },      'Mesas salvas!');

// â”€â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadArray(url, size) {
  try {
    const res  = await fetch(url + '?t=' + Date.now());
    const text = await res.text();
    const m    = text.match(/\[([^\]]+)\]/s);
    if (m) {
      const parsed = m[1].split(',').map(n => parseInt(n.trim(), 10));
      if (parsed.length === size) return parsed;
    }
  } catch {}
  return new Array(size).fill(0);
}

// â”€â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  const status = document.getElementById('status');
  status.textContent = 'Carregando dados...';
  status.style.color = '#aaa';

  [collisions, zones] = await Promise.all([
    loadArray('/data/collisions.js', COLS * ROWS),
    loadArray('/data/zones.js',      COLS * ROWS),
  ]);

  mapImg.onload = () => {
    mapLoaded = true;
    status.textContent = 'Pronto â€” clique para editar';
    status.style.color = '#00cc66';
    redrawAll();
  };
  mapImg.onerror = () => {
    status.textContent = 'Sem imagem do mapa â€” edite assim mesmo';
    status.style.color = '#ffcc00';
    redrawAll();
  };
  mapImg.src = '/img/map.png?t=' + Date.now();
})();
</script>
</body>
</html>
